<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>orca</title>
<style>
  body, html {
    margin:0; height:100vh; background:#000; display:flex; justify-content:center; align-items:center; color:#0f0;
    user-select:none;
    font-family: monospace;
    overflow: hidden;
  }
  #info {
    position: fixed; top:10px; left:10px;
    background:rgba(0,0,0,0.7);
    padding:10px; border-radius:5px;
  }
</style>
</head>
<body>
<div id="info">마우스 누르고 움직이거나 터치해서 음 조절하기</div>
<script>
(async function(){
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  const ctx = new AudioContext();

  // Oscillators
  const osc1 = ctx.createOscillator();
  const osc2 = ctx.createOscillator();
  const osc3 = ctx.createOscillator();

  // Gain nodes for each osc to 조절
  const gain1 = ctx.createGain();
  const gain2 = ctx.createGain();
  const gain3 = ctx.createGain();

  // 메인 게인
  const mainGain = ctx.createGain();
  mainGain.gain.value = 0;

  // Delay + feedback (에코 효과)
  const delay = ctx.createDelay();
  delay.delayTime.value = 0.10; // 150ms

  const feedback = ctx.createGain();
  feedback.gain.value = 0.01; // 덜 울리도록 피드백 줄임

  // 연결: delay feedback loop
  delay.connect(feedback);
  feedback.connect(delay);

  // 오실레이터 -> 각각 gain -> mainGain -> delay -> destination
  osc1.connect(gain1);
  osc2.connect(gain2);
  osc3.connect(gain3);

  gain1.connect(mainGain);
  gain2.connect(mainGain);
  gain3.connect(mainGain);

  mainGain.connect(delay);
  delay.connect(ctx.destination);
  mainGain.connect(ctx.destination);

  // 파형 종류 세팅
  osc1.type = 'sine';      // 부드럽고 주된 음
  osc2.type = 'triangle';  // 약간 질감
  osc3.type = 'sawtooth';  // 조금 거칠게

  // 볼륨 비율 - sine 중심, 나머지 작게
  gain1.gain.value = 0.25;
  gain2.gain.value = 0.1;
  gain3.gain.value = 0.08;

  osc1.start();
  osc2.start();
  osc3.start();

  // Vibrato용 LFO 생성
  const lfo = ctx.createOscillator();
  const lfoGain = ctx.createGain();
  lfo.frequency.value = 5; // 5Hz 진동 (vibrato 속도)
  lfoGain.gain.value = 10; // 진폭 진동 폭(Hz)

  lfo.connect(lfoGain);

  // lfoGain 연결용 변수
  let currentFreq = 0;

  function setFrequency(freq){
    currentFreq = freq;
    // 실제 주파수 조절
    osc1.frequency.setTargetAtTime(freq, ctx.currentTime, 0.05);
    osc2.frequency.setTargetAtTime(freq * 1.1, ctx.currentTime, 0.05);
    osc3.frequency.setTargetAtTime(freq * 0.9, ctx.currentTime, 0.05);
  }

  lfo.start();

  function freqFromY(y){
    const height = window.innerHeight;
    const norm = 1 - y / height; // 위쪽이 1, 아래가 0
    return 500 + norm * 1500; // 500 ~ 2000 Hz
  }

  function startAudio(){
    if(ctx.state === 'suspended') ctx.resume();
  }

  function onMove(evt){
    if(evt.buttons === 1 || (evt.touches && evt.touches.length > 0)){
      startAudio();
      let y = evt.touches ? evt.touches[0].clientY : evt.clientY;
      setFrequency(freqFromY(y));
      mainGain.gain.setTargetAtTime(0.3, ctx.currentTime, 0.05);
    } else {
      mainGain.gain.setTargetAtTime(0, ctx.currentTime, 0.4);
    }
  }

  window.addEventListener('mousemove', onMove);
  window.addEventListener('mousedown', onMove);
  window.addEventListener('mouseup', onMove);
  window.addEventListener('touchstart', onMove);
  window.addEventListener('touchmove', onMove);
  window.addEventListener('touchend', onMove);

})();
</script>
</body>
</html>
